# HIVE Execute
# Execute a sequence of HIVE commands
# Ensure proper logging and mailing

##
# Configuration variables
#
_ETL_ALERT_EMAIL='you@email.com'

##
# Helper functions
#
basedir() {
    BASEDIR=$(dirname $0)
    if [ -z "$1" ]
    then
        echo `readlink -f $BASEDIR`
    else
        echo `readlink -f $BASEDIR/../$1`
    fi
}

##
# Environment variables for run process
#
export _ETL_EXEC_NAME=$1
export _ETL_EXEC_DATE=`date +%Y-%m-%d`
export _ETL_EXEC_TIME=`date +%H%M`
export _ETL_LOG_PATH=`basedir log`/$_ETL_EXEC_NAME/$_ETL_EXEC_DATE/$_ETL_EXEC_TIME-$RANDOM
export _ETL_BIN_PATH=`basedir bin`
export _ETL_SQL_PATH=`basedir sql`
export _ETL_SCRIPTS_PATH=`basedir scripts`
export _ETL_TRANSFORM_PATH=`basedir transform`
export _ETL_EXEC_LOG=$_ETL_LOG_PATH/$_ETL_EXEC_NAME.log
export PATH=$PATH:$_ETL_BIN_PATH:$_ETL_SQL_PATH:$_ETL_TRANSFORM_PATH:$_ETL_LIB_PATH:$_ETL_CONF_PATH

##
# Create logging paths
#
mkdir -p $_ETL_LOG_PATH $_ETL_LOG_PATH/hive
sh $_ETL_SCRIPTS_PATH/$_ETL_EXEC_NAME &> $_ETL_EXEC_LOG

_ETL_SUCCESS="SUCCESS"
if `cat $_ETL_EXEC_LOG | grep -iE "ERROR|FAIL|FATAL|cannot open|error" 1>/dev/null 2>&1`
then
    _ETL_SUCCESS="FAILED"
fi

cat $_ETL_EXEC_LOG | mail\
    -s "[LOG] $_ETL_EXEC_NAME $_ETL_SUCCESS ($_ETL_EXEC_DATE)"\
    $_ETL_ALERT_EMAIL
